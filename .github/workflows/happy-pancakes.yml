name: Happy Pancakes
on:
  pull_request:
    types: [opened, edited, labeled, unlabeled, synchronize, ready_for_review, auto_merge_enabled, auto_merge_disabled]
  status: {}
  check_run:
    types: [created, completed]
  check_suite: 
    types: [created, completed]
jobs:
  check_status:
    name: Check Status
    runs-on: ubuntu-latest
    steps:
      - name: Check Status
        uses: actions/github-script@v4
        with:
          script: |
            let pull = await github.pulls.get({
              owner: "ctiller",
              repo: "grpc-wf",
              pull_number: ${{ github.event.pull_request.number }}
            });
            console.log(pull.data.labels.size);
            for (var i = 0; i < pull.data.labels.size; i++) {
              let label = pull.data.labels[i];
              console.log("label: ", label);
              if (label.name == "force-merge") {
                console.log("Saw force-merge label");
                return;
              }
            }
            let statuses = await github.repos.listCommitStatusesForRef({
              owner: "ctiller",
              repo: "grpc-wf",
              ref: "${{ github.ref }}"
            });
            need = new Set();
            need.add("Bazel Basic build for C/C++");
            need.add("Portability Tests Linux [Build Only] (internal CI)");
            for (let status in statuses) {
              if (status.state == "success") {
                need.delete(status.context);
              }
            }
            if (need.size == 0) {
              return;
            }
            console.log(need);
            core.setFailed("Waiting for: " + [...need].join(', '));

